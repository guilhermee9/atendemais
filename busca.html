<!DOCTYPE html>
<html>

<head>
    <title>Cadastros Servi√ßos</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js" defer></script>
    <link rel="stylesheet" href="style.css">

</head>

<body>
    <header>
        <div class="menu-icon" onclick="toggleMenu()">&#9776;</div>
        <h1>Servi√ßos</h1>
    </header>
    <div class="sidebar" id="mySidebar">
        <a href="#" onclick="closeMenu()"><span class="menu-icon close-icon">&#9776;</span></a>
        <a href="agenda.html">Agenda do dia</a>
        <a href="ordens.html">Ordens</a>
        <a href="busca.html">Busca pessoa</a>
        <a href="cadastroPessoa.html">Pessoas</a>
        <a href="cadastroAtendimento.html">Criar atendimento</a>
    </div>

    <script>
        function toggleMenu() {
            var sidebar = document.getElementById("mySidebar");
            sidebar.classList.toggle("active");
        }

        function closeMenu() {
            var sidebar = document.getElementById("mySidebar");
            sidebar.classList.remove("active");
        }
    </script>
    <br>
    <br>

    <!-- Adicione o campo de busca com auto-completar -->
    <form id="buscaPessoa">
        <input type="text" id="campoBusca" placeholder="Buscar pessoa pelo nome..." autocomplete="off">
        <ul id="sugestoes"
            style="list-style: none; padding: 0; margin: 0; display: none; background-color: #fff; border: 1px solid #ccc; border-radius: 4px; max-height: 150px; overflow-y: auto;">
        </ul>
    </form>
    <br>

    <div id="resultados"></div>
    <div id="meuModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modal-detalhes"></div>
        </div>
    </div>
    <script type="module">

        const resultadosDiv = document.getElementById('resultados');
        const modal = document.getElementById("meuModal");
        const modalDetalhes = document.getElementById("modal-detalhes");
        const span = document.getElementsByClassName("close")[0];

        span.onclick = function () {
            modal.style.display = "none";
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        function buscarAtendimentos() {
            resultadosDiv.innerHTML = "";

            db.collection("atendimentos")
                .orderBy("data", "desc") // Ordena pela data em ordem decrescente
                .limit(10) // Limita a 10 resultados
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        resultadosDiv.innerHTML = "<p>Nenhuma ordem encontrada.</p>";
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const atendimento = doc.data();
                        let dataFormatada = "";

                        if (atendimento.data) {
                            if (atendimento.data instanceof firebase.firestore.Timestamp) {
                                dataFormatada = atendimento.data.toDate().toLocaleDateString('pt-BR');
                            } else if (typeof atendimento.data === 'string') {
                                try {
                                    const dataObj = new Date(atendimento.data);
                                    dataFormatada = dataObj.toLocaleDateString('pt-BR');
                                } catch (error) {
                                    console.error("Erro ao converter string para data:", error);
                                    dataFormatada = "Data inv√°lida";
                                }
                            } else {
                                dataFormatada = "Formato de data desconhecido";
                            }
                        }

                        // Busca o nome da pessoa na cole√ß√£o "pessoas"
                        if (atendimento.pessoaId && typeof atendimento.pessoaId === "string" && atendimento.pessoaId.trim() !== "") {
                            db.collection("pessoas").doc(atendimento.pessoaId).get()
                                .then((pessoaDoc) => {
                                    const pessoaNome = pessoaDoc.exists ? pessoaDoc.data().nome : "Pessoa n√£o encontrada";

                                    const resultadoItem = document.createElement('div');
                                    resultadoItem.classList.add('resultado-item');
                                    resultadoItem.innerHTML = `
                                        <p><strong>üìÖ Data:</strong> ${dataFormatada || "N√£o informada"}</p>
                                        <p><strong>‚è∞ Hora:</strong> ${atendimento.hora || "N√£o informada"}</p>
                                        <p><strong>üë§ Pessoa:</strong> ${pessoaNome}</p>
                                        <p><strong>üõ† Servi√ßos/Produtos:</strong> ${atendimento.problema || "N√£o informado"}</p>
                                        <div class="action">Ver mais detalhes</div>
                                    `;

                                    resultadoItem.addEventListener('click', () => {
                                        exibirDetalhes(doc);
                                    });

                                    resultadosDiv.appendChild(resultadoItem);
                                })
                                .catch((error) => {
                                    console.error("Erro ao buscar pessoa associada:", error);
                                    resultadosDiv.innerHTML += `
                                        <div class="resultado-item">
                                            <p><strong>üìÖ Data:</strong> ${dataFormatada || "N√£o informada"}</p>
                                            <p><strong>‚è∞ Hora:</strong> ${atendimento.hora || "N√£o informada"}</p>
                                            <p><strong>üë§ Pessoa:</strong> Erro ao buscar pessoa</p>
                                            <p><strong>üõ† Servi√ßos/Produtos:</strong> ${atendimento.servicos || "N√£o informado"}</p>
                                            <p><strong>üíµ Pre√ßo:</strong> R$ ${atendimento.preco || "0,00"}</p>
                                        </div>
                                    `;
                                });
                        } else {
                            const resultadoItem = document.createElement('div');
                            resultadoItem.classList.add('resultado-item');
                            resultadoItem.innerHTML = `
                                <p><strong>üìÖ Data:</strong> ${dataFormatada || "N√£o informada"}</p>
                                <p><strong>‚è∞ Hora:</strong> ${atendimento.hora || "N√£o informada"}</p>
                                <p><strong>üë§ Pessoa:</strong> N√£o associado a nenhuma pessoa</p>
                                <p><strong>üõ† Servi√ßos/Produtos:</strong> ${atendimento.problema || "N√£o informado"}</p>
                                <p><strong>üíµ Pre√ßo:</strong> R$ ${atendimento.preco || "0,00"}</p>
                                <div class="action">Ver mais detalhes</div>
                            `;

                            resultadoItem.addEventListener('click', () => {
                                exibirDetalhes(doc);
                            });

                            resultadosDiv.appendChild(resultadoItem);
                        }
                    });
                })
                .catch((error) => {
                    console.error("Erro ao buscar ordens: ", error);
                    resultadosDiv.innerHTML = "<p>Erro ao buscar ordens. Consulte o console.</p>";
                });
        }

        function exibirDetalhes(doc) {
            const atendimento = doc.data();
            modalDetalhes.innerHTML = "";

            let dataFormatada = "";
            if (atendimento.data) {
                if (atendimento.data instanceof firebase.firestore.Timestamp) {
                    dataFormatada = atendimento.data.toDate().toLocaleDateString('pt-BR'); // Formata√ß√£o para pt-BR (DD/MM/AAAA)
                } else if (typeof atendimento.data === 'string') {
                    try {
                        const dataObj = new Date(atendimento.data);
                        dataFormatada = dataObj.toLocaleDateString('pt-BR');
                    } catch (error) {
                        console.error("Erro ao converter string para data:", error);
                        dataFormatada = "Data inv√°lida";
                    }
                } else {
                    dataFormatada = "Formato de data desconhecido";
                }
            }

            // Verifica se h√° um `pessoaId` associado ao atendimento
            if (atendimento.pessoaId) {
                db.collection("pessoas").doc(atendimento.pessoaId).get()
                    .then((pessoaDoc) => {
                        if (pessoaDoc.exists) {
                            const pessoa = pessoaDoc.data();

                            modalDetalhes.innerHTML = `                                
                                <p><strong>Nome:</strong> ${pessoa.nome || "N√£o informado"}</p>
                                <p><strong>Telefone:</strong> ${pessoa.telefone || "N√£o informado"}</p>
                                <p><strong>Contato:</strong> ${pessoa.contato || "N√£o informado"}</p>
                                <p><strong>Endere√ßo:</strong> ${pessoa.endereco || "N√£o informado"}</p>
                                <p><strong>Data:</strong> ${dataFormatada || "N√£o informada"}</p>
                                <br>
                                <p><strong>Problema:</strong> ${atendimento.problema || "N√£o informado"}</p>
                                <p><strong>Solu√ß√£o:</strong> ${atendimento.solucao || "N√£o informada"}</p>
                                <p><strong>Observa√ß√µes:</strong> ${atendimento.observacoes || "N√£o informadas"}</p>
                            `;
                        } else {
                            modalDetalhes.innerHTML = `
                                <p><strong>ID do documento:</strong> ${doc.id}</p>
                                <p><strong>ID:</strong> ${atendimento.id || "N√£o informado"}</p>
                                <p><strong>Nome:</strong> Pessoa n√£o encontrada</p>
                                <p><strong>Data:</strong> ${dataFormatada || "N√£o informada"}</p>
                                <p><strong>Problema:</strong> ${atendimento.problema || "N√£o informado"}</p>
                                <p><strong>Solu√ß√£o:</strong> ${atendimento.solucao || "N√£o informada"}</p>
                                <p><strong>Observa√ß√µes:</strong> ${atendimento.observacoes || "N√£o informadas"}</p>
                            `;
                        }

                        modal.style.display = "block"; // Exibe o modal
                    })
                    .catch((error) => {
                        console.error("Erro ao buscar pessoa associada:", error);
                        modalDetalhes.innerHTML = `
                            <p><strong>ID do documento:</strong> ${doc.id}</p>
                            <p><strong>ID:</strong> ${atendimento.id || "N√£o informado"}</p>
                            <p><strong>Nome:</strong> Erro ao buscar pessoa</p>
                            <p><strong>Data:</strong> ${dataFormatada || "N√£o informada"}</p>
                            <p><strong>Problema:</strong> ${atendimento.problema || "N√£o informado"}</p>
                            <p><strong>Solu√ß√£o:</strong> ${atendimento.solucao || "N√£o informada"}</p>
                            <p><strong>Observa√ß√µes:</strong> ${atendimento.observacoes || "N√£o informadas"}</p>
                        `;
                        modal.style.display = "block"; // Exibe o modal
                    });
            } else {
                modalDetalhes.innerHTML = `
                    <p><strong>ID do documento:</strong> ${doc.id}</p>
                    <p><strong>ID:</strong> ${atendimento.id || "N√£o informado"}</p>
                    <p><strong>Nome:</strong> N√£o associado a nenhuma pessoa</p>
                    <p><strong>Data:</strong> ${dataFormatada || "N√£o informada"}</p>
                    <p><strong>Problema:</strong> ${atendimento.problema || "N√£o informado"}</p>
                    <p><strong>Solu√ß√£o:</strong> ${atendimento.solucao || "N√£o informada"}</p>
                    <p><strong>Observa√ß√µes:</strong> ${atendimento.observacoes || "N√£o informadas"}</p>
                `;
                modal.style.display = "block"; // Exibe o modal
            }
        }

        window.addEventListener('load', buscarAtendimentos);

        const campoBusca = document.getElementById('campoBusca');
        const sugestoes = document.getElementById('sugestoes');

        // Fun√ß√£o para buscar pessoas no Firestore
        async function buscarPessoas(nome) {
            try {
                const querySnapshot = await db.collection("pessoas")
                    .where("nome", ">=", nome)
                    .where("nome", "<=", nome + "\uf8ff")
                    .get();

                const resultados = [];
                querySnapshot.forEach((doc) => {
                    resultados.push({ id: doc.id, ...doc.data() });
                });

                return resultados;
            } catch (error) {
                console.error("Erro ao buscar pessoas:", error);
                return [];
            }
        }

        // Evento para capturar a digita√ß√£o no campo de busca
        campoBusca.addEventListener('input', async (event) => {
            const valor = event.target.value.trim();

            // Exibe sugest√µes apenas se houver pelo menos 3 caracteres
            if (valor.length >= 3) {
                const resultados = await buscarPessoas(valor);

                // Limpa as sugest√µes anteriores
                sugestoes.innerHTML = "";

                if (resultados.length > 0) {
                    resultados.forEach((pessoa) => {
                        const item = document.createElement('li');
                        item.textContent = pessoa.nome;
                        item.style.padding = "10px";
                        item.style.cursor = "pointer";

                        // Evento para buscar atendimentos ao clicar em uma sugest√£o
                        item.addEventListener('click', () => {
                            buscarAtendimentosPorPessoa(pessoa.id);
                            sugestoes.style.display = "none";
                            campoBusca.value = pessoa.nome;
                        });

                        sugestoes.appendChild(item);
                    });

                    sugestoes.style.display = "block";
                } else {
                    sugestoes.style.display = "none";
                }
            } else {
                sugestoes.style.display = "none";
            }
        });

        // Fun√ß√£o para buscar atendimentos por pessoa
        async function buscarAtendimentosPorPessoa(pessoaId) {

            resultadosDiv.innerHTML = "";

            try {
                // Certifique-se de que o pessoaId √© uma string
                const pessoaIdString = pessoaId.toString();

                // Consulta ordenada por data (mais recente primeiro)
                const querySnapshot = await db.collection("atendimentos")
                    .where("pessoaId", "==", pessoaIdString)
                    .orderBy("data", "desc") // Ordena pela data em ordem decrescente
                    .get();

                if (querySnapshot.empty) {

                    resultadosDiv.innerHTML = "<p>Nenhum atendimento encontrado para esta pessoa.</p>";
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const atendimento = doc.data();

                    let dataFormatada = "";

                    if (atendimento.data) {
                        if (atendimento.data instanceof firebase.firestore.Timestamp) {
                            dataFormatada = atendimento.data.toDate().toLocaleDateString('pt-BR');
                        } else if (typeof atendimento.data === 'string') {
                            try {
                                const dataObj = new Date(atendimento.data);
                                dataFormatada = dataObj.toLocaleDateString('pt-BR');
                            } catch (error) {
                                console.error("Erro ao converter string para data:", error);
                                dataFormatada = "Data inv√°lida";
                            }
                        } else {
                            dataFormatada = "Formato de data desconhecido";
                        }
                    }

                    const resultadoItem = document.createElement('div');
                    resultadoItem.classList.add('resultado-item');
                    resultadoItem.innerHTML = `
                        <p><strong>üìÖ Data:</strong> ${dataFormatada || "N√£o informada"}</p>
                        <p><strong>‚è∞ Hora:</strong> ${atendimento.hora || "N√£o informada"}</p>
                        <p><strong>üõ† Servi√ßos/Produtos:</strong> ${atendimento.servicos || "N√£o informado"}</p>
                        <p><strong>üíµ Pre√ßo:</strong> R$ ${atendimento.preco || "0,00"}</p>
                        <div class="action">Ver mais detalhes</div>
                    `;

                    resultadoItem.addEventListener('click', () => {
                        exibirDetalhes(doc);
                    });

                    resultadosDiv.appendChild(resultadoItem);
                });
            } catch (error) {
                console.error("Erro ao buscar atendimentos por pessoa:", error);
                resultadosDiv.innerHTML = "<p>Erro ao buscar atendimentos. Consulte o console.</p>";
            }
        }
    </script>

</body>

</html>