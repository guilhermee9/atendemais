<!DOCTYPE html>
<html>

<head>
    <title>Formulário de Atendimento</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js" defer></script>
</head>

<body>
    <header>
        <div class="logo">
            <img src="/img/logo.png" alt="Seu Logo">
        </div>
        <div class="menu-icon" onclick="toggleMenu()">&#9776;</div>
    </header>

    <div class="sidebar" id="mySidebar">
        <a href="#" onclick="closeMenu()"><span class="menu-icon close-icon">&#9776;</span></a>
        <a href="#">Ordens de Serviço</a>
        <a href="#">Consultar</a>
        <a href="#">Cadastrar Usuário</a>
    </div>

    <h2>Buscar Atendimentos</h2>
    <input type="text" id="buscaNome" placeholder="Buscar por nome">
    <input type="date" id="buscaData">
    <button onclick="buscarAtendimentos()">Buscar</button>

    <div id="resultados"></div>

    <script>

        const formulario = document.getElementById('formularioAtendimento');

        function buscarAtendimentos() {
            const nomeBusca = document.getElementById('buscaNome').value.toLowerCase();
            const dataBusca = document.getElementById('buscaData').value;

            let nomeQuery = null;
            let dataQuery = null;
            let queries = [];

            if (nomeBusca) {
                nomeQuery = db.collection("atendimentos").where("nome", ">=", nomeBusca).where("nome", "<=", nomeBusca + "\uf8ff");
                queries.push(nomeQuery);
            }

            if (dataBusca) {
                const dataInicio = new Date(dataBusca);
                dataInicio.setHours(0, 0, 0, 0);
                const dataFim = new Date(dataBusca);
                dataFim.setHours(23, 59, 59, 999);
                dataQuery = db.collection("atendimentos").where("datahora", ">=", dataInicio.toISOString()).where("datahora", "<=", dataFim.toISOString());
                queries.push(dataQuery);
            }

            resultadosDiv.innerHTML = "";

            if (queries.length === 0) {
                resultadosDiv.innerHTML = "<p>Nenhum critério de busca fornecido.</p>";
                return;
            }

            Promise.all(queries.map(query => query.get()))
                .then(snapshots => {
                    let results = new Set();

                    snapshots.forEach(snapshot => {
                        if (!snapshot.empty) {
                            snapshot.forEach(doc => {
                                results.add(doc.id);
                            });
                        }
                    });
                    if (results.size === 0) {
                        resultadosDiv.innerHTML = "<p>Nenhum resultado encontrado.</p>";
                    } else {
                        results.forEach(docId => {
                            db.collection("atendimentos").doc(docId).get().then((doc) => {
                                if (doc.exists) {
                                    const data = doc.data();
                                    const resultadoItem = document.createElement('div');
                                    resultadoItem.classList.add('resultado-item');
                                    resultadoItem.innerHTML = `
                                        <p><strong>Nome:</strong> ${data.nome}</p>
                                        <p><strong>Data/Hora:</strong> ${new Date(data.datahora).toLocaleString()}</p>
                                        <p><strong>Problema:</strong> ${data.problema}</p>
                                        <p><strong>Solução:</strong> ${data.solucao || "Não informada"}</p>
                                        <p><strong>Observações:</strong> ${data.observacoes || "Não informadas"}</p>
                                    `;
                                    resultadosDiv.appendChild(resultadoItem);
                                } else {
                                    console.log("No such document!");
                                }
                            }).catch((error) => {
                                console.log("Error getting document:", error);
                            });
                        })
                    }

                })
                .catch(error => {
                    console.error("Erro nas buscas: ", error);
                    resultadosDiv.innerHTML = "<p>Erro nas buscas. Consulte o console.</p>";
                });
        }

        function toggleMenu() {
            var sidebar = document.getElementById("mySidebar");
            sidebar.classList.toggle("active");
        }

        function closeMenu() {
            var sidebar = document.getElementById("mySidebar");
            sidebar.classList.remove("active");
        }
    </script>
</body>

</html>