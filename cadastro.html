<!DOCTYPE html>
<html>

<head>
    <title>Formulário de Atendimento</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js" defer></script>
</head>

<body>
    <header>
        <div class="logo">
            <img src="/img/logo.png" alt="Seu Logo">
        </div>
        <div class="menu-icon" onclick="toggleMenu()">&#9776;</div>
    </header>

    <div class="sidebar" id="mySidebar">
        <a href="#" onclick="closeMenu()"><span class="menu-icon close-icon">&#9776;</span></a>
        <a href="ordens.html">Ordens de Serviço</a>
        <a href="busca.html">Consultar</a>
        <a href="cadastro.html">Criar atendimento</a>
    </div>

    <h1 style="text-align: center;">Formulário de Atendimento</h1>
    <form id="formularioAtendimento">
        <input type="text" id="nome" name="nome" placeholder="Nome" required>
        <input type="date" id="datahora" name="datahora" placeholder="Data" required>
        <textarea id="problema" name="problema" rows="4" required placeholder="Problema"></textarea>
        <textarea id="solucao" name="solucao" rows="4" placeholder="Solução"></textarea>
        <textarea id="observacoes" name="observacoes" rows="4" placeholder="Observações"></textarea>
        <button type="submit">Enviar</button>
        <button type="reset">Limpar</button>
    </form>

    <script>
        function toggleMenu() {
            var sidebar = document.getElementById("mySidebar");
            sidebar.classList.toggle("active");
        }

        function closeMenu() {
            var sidebar = document.getElementById("mySidebar");
            sidebar.classList.remove("active");
        }

        const formulario = document.getElementById('formularioAtendimento');

        // Função para obter o próximo ID sequencial
        async function getNextId() {
            const counterRef = db.collection('counters').doc('atendimentos_counter');

            try {
                const doc = await counterRef.get();
                if (doc.exists) {
                    const currentCount = doc.data().count;
                    await counterRef.update({ count: currentCount + 1 });
                    return currentCount + 1;
                } else {
                    await counterRef.set({ count: 1 });
                    return 1;
                }
            } catch (error) {
                console.error("Erro ao obter o próximo ID:", error);
                throw error; // Importante: re-lança o erro
            }
        }

        formulario.addEventListener('submit', async (event) => {
            event.preventDefault();

            try {
                const nextId = await getNextId();

                const nome = document.getElementById('nome').value;
                const datahora = document.getElementById('datahora').value;
                const problema = document.getElementById('problema').value;
                const solucao = document.getElementById('solucao').value;
                const observacoes = document.getElementById('observacoes').value;

                await db.collection("atendimentos").doc(nextId.toString()).set({
                    id: nextId,
                    nome: nome,
                    datahora: datahora,
                    problema: problema,
                    solucao: solucao,
                    observacoes: observacoes
                });

                alert("Dados enviados com sucesso!");
                formulario.reset();
            } catch (error) {
                console.error("Erro ao enviar dados: ", error);
                alert("Erro ao enviar dados. Consulte o console.");
            }
        });

    </script>
</body>

</html>